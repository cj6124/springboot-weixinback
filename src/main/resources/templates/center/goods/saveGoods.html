<div xmlns:th="http://www.thymeleaf.org">
	<!-- BEGIN PAGE HEADER-->
	<!-- BEGIN PAGE BAR -->
	<div class="page-bar">
	    <ul class="page-breadcrumb">
	        <li>
	            <span>首页</span>
	            <i class="fa fa-circle"></i>
	        </li>
	        <li>
	            <span>商品管理</span>
	            <i class="fa fa-circle"></i>
	        </li>
	        <li>
	            <span>添加商品</span>
	        </li>
	    </ul>
	</div>
	<!-- END PAGE BAR -->
	<!-- END PAGE HEADER-->
                        
	<div class="row">
    	<div class="col-md-12">
			<br/>
			<!-- 意见反馈 start -->
			<div class="tabbable-line boxless tabbable-reversed">
            	<div class="portlet box green-jungle">
                	<div class="portlet-title">
                    	<div class="caption">
                            <i class="icon-plus"></i><span th:text="${goods==null?'添加商品':'编辑商品'}"></span>
                    	</div>
					</div>
					
					<div class="portlet-body form">
					
	                    <!-- BEGIN FORM-->
	                    <form id="saveGoodsForm" class="form-horizontal">
		                    <div class="form-body">

                                <input hidden="hidden" name="goodsId" type="text" th:value="${goods?.goodsId}">

		                    	<div class="form-group">
		                        	<label class="col-md-3 control-label"><span class="field-required"> * </span>商品名字:</label>
		                            <div class="col-md-4">
		                            	<div id="input-error">
		                            		<input id="goodsName" name="goodsName" type="text" class="form-control" th:value="${goods?.goodsName}" placeholder="1-8字">
		                            	</div>
									</div>
								</div>

								<div class="form-group">
									<label class="col-md-3 control-label"><span class="field-required"> * </span>商品简述:</label>
									<div class="col-md-4">
										<div id="input-error">
											<input id="goodsCharacteristic" name="goodsCharacteristic" type="text" class="form-control" th:value="${goods?.goodsCharacteristic}"  placeholder="1~15字之内">
										</div>
									</div>
								</div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>商品原价:</label>
                                    <div class="col-md-4">
                                        <div id="input-error">
                                            <input id="goodsOriginalprice" name="goodsOriginalprice" type="number" class="form-control" th:value="${goods?.goodsOriginalprice}" placeholder="请输入商品原价">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>折扣价格:</label>
                                    <div class="col-md-4">
                                        <div id="input-error">
                                            <input id="goodsMinprice" name="goodsMinprice" type="number" class="form-control" th:value="${goods?.goodsMinprice}" placeholder="非必须，建议热门商品填上">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>商品库存:</label>
                                    <div class="col-md-4">
                                        <div id="input-error">
                                            <input id="goodsStock" name="goodsStock" type="number" class="form-control" th:value="${goods?.goodsStock}" placeholder="清输入商品库存">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>商品状态:</label>
                                    <div class="col-md-4">
                                        <div id="input-error">
                                            <select id="goodsStatus" name="goodsStatus" class="form-control">
                                                <option value="1" th:selected="${goods?.goodsStatus==1}">上架</option>
                                                <option value="0" th:selected="${goods?.goodsStatus==0}">下架</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>是否热门:</label>
                                    <div class="col-md-4">
                                        <div id="input-error">
                                            <select id="goodsIsHot" name="goodsIsHot" class="form-control">
                                                <option value="0" th:selected="${goods?.goodsIsHot==0}">否</option>
                                                <option value="1" th:selected="${goods?.goodsIsHot==1}">是</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

								<div class="form-group">
									<label class="col-md-3 control-label"><span class="field-required"> * </span>所属分类:</label>
									<div class="col-md-4">
										<div id="input-error">
											<select id="categoryId" name="categoryId" class="form-control">
												<div th:each="category : ${categories}">
													<option th:value="${category.categoryId}" th:text="${category.categoryName + ((category.categoryStatus==1)?'':'(已禁用)')}"
                                                            th:selected="${category.categoryId==goods?.categoryId}"></option>
												</div>
											</select>
										</div>
									</div>
								</div>

								<div class="form-group">
		                        	<label class="col-md-3 control-label"><span class="field-required"> * </span>商品视频:</label>
		                            <div class="col-md-4">
		                            	<div id="input-error">
		                            		<input id="goodsVideourl" name="goodsVideourl" type="text" class="form-control" th:value="${goods?.goodsVideourl}" placeholder="可不设置，此栏在上传视频(.mp4格式)后自动填写" readonly>
											<input id="video" type="file" name="video" accept="audio/mp4,video/mp4"/>
											<div id="videoContent"></div>
		                            	</div>
									</div>
								</div>

								<div class="form-group">
		                        	<label class="col-md-3 control-label"><span class="field-required"> * </span>商品封面</label>
		                            <div class="col-md-4">
		                            	<div id="input-error">
	                            			<input id="goodsPicurl" name="goodsPicurl" type="text" class="form-control" th:value="${goods?.goodsPicurl}" placeholder="必须设置，此栏在上传封面（.jpg.png）后自动填写" readonly/>
											<input id="pic" type="file" name="pic" accept="image/jpeg,image/png"/>
											<div id="picContent"></div>
	                            		</div>
									</div>
								</div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>商品轮播图:</label>
                                    <div class="col-md-4">
                                        <div id="input-error">
                                            <div id="pics-con">
                                                <input id="goodsPics" name="goodsPics" type="text" class="form-control" th:value="${pics==null?'':'(双击图片可删除)'}" placeholder="可批量选择图片(上传完后此处显示上传成功)" readonly/>
                                                <input id="pics" type="file" name="pic" accept="image/jpeg,image/png" multiple/>
                                                <p th:each="pic : ${pics}">
                                                    <img ondblclick="deleteImage(this)" class="img-rounded img-responsive" th:src="${pic.imageUrl}" />
                                                    <input hidden='hidden' name='picsUrl' th:value="${pic.imageUrl}" />
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-3 control-label"><span class="field-required"> * </span>商品详情:</label>
                                    <div class="col-md-6">
                                        <div id="input-error">
                                            <div id="wangEditor" th:utext="${goods?.goodsContent}"></div >
                                            <button type="button" class="btn-default" id="button1">获取</button>
                                        </div>
                                    </div>
                                </div>
		                                                  
							</div>
	                                                        
							<div class="form-actions">
			                    <div class="row">
			                        <div class="col-md-offset-3 col-md-9">
			                            <button type="submit" class="btn btn-success">提 交</button>
			                            <button type="button" class="btn btn-default" onclick="$('#goodsListMenu').click()">返回</button>
			                            <button type="reset" class="btn btn-danger">重 置</button>
			                        </div>
			                    </div>
							</div>
						</form>
						<!-- END FORM-->
						
					</div>
				</div>
			</div>
                            
		</div>
	</div>
	
<script type="text/javascript">

    //初始化ueditor
    var E = window.wangEditor;
    var editor = new E('#wangEditor');
    //定义上传图片的接口
    editor.customConfig.uploadImgServer = $("#fileServer").val() + '/file/uploadimage';
    //配置指定文件名
    editor.customConfig.uploadFileName = 'upfile';
    //限制图片大小为10mb
    editor.customConfig.uploadImgMaxSize = 10 * 1024 * 1024;
    editor.create();

    // 获取editor的html内容
    document.getElementById('button1').addEventListener('click', function () {
        // 读取 html
        alert(editor.txt.html())
    }, false);

    // 上传单张封面
    $("#pic").fileupload({
		url: '/file/uploadImage',
    	dataType: "json",
    	done: function(e, data) {

    		if (data.result.status != '200') {
                layer.msg('上传失败了', {icon: 5});
    		} else {
    			var fileServer = $("#fileServer").val();
    			var url = fileServer + data.result.data;
    			$("#picContent").html("<img class='img-rounded img-responsive col-md-3' src='" + url + "' />");
    			$("#goodsPicurl").val(url);
                layer.msg('上传成功', {
                    icon: 6,
                    time: 2000
                });
    		}
    	},
        progressall: function (e, data) {//上传进度
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $("#picContent").html("上传总进度："+progress+"%");
        },
        fail: function () {
            layer.msg('上传失败了', {icon: 5});
        }
    });

    // 上传轮播图，可批量
    $("#pics").fileupload({
        multipart: true,
        url: '/file/uploadImage',
        dataType: "json",
        done: function(e, data) {

            if (data.result.status != '200') {
                layer.msg('上传失败了', {icon: 5});
                $("#goodsPics").val("上传失败");
            } else {
                var fileServer = $("#fileServer").val();
                var url = fileServer + data.result.data;
                $("#pics-con").append("<p>" +
                                        "<img ondblclick='deleteImage(this)' class='img-rounded img-responsive' src='" + url + "' />" +
                                        "<input hidden='hidden' name='picsUrl' value='" + url+ "' />" +
                                      "</p>");
                $("#goodsPics").val("上传成功(双击图片可删除)");
                layer.msg('上传成功', {
                    icon: 6,
                    time: 2000
                });
            }
        },
        progressall: function (e, data) {//上传进度
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $("#goodsPics").html("上传总进度："+progress+"%");
        },
        fail: function () {
            layer.msg('上传失败了', {icon: 5});
            $("#goodsPics").val("上传失败");
        }
    });
    //删除图片的标签元素
    function deleteImage(e){
        e.parentNode.remove();
        layer.msg('删除成功', {icon: 6});
    }

    // 上传视频
    $("#video").fileupload({
        url: '/file/uploadVideo',
        dataType: "json",
        done: function(e, data) {
            if (data.result.status != '200') {
                layer.msg('上传失败了', {icon: 5});
            } else {
                var fileServer = $("#fileServer").val();
                var url = fileServer + data.result.data;
                $("#videoContent").html("<a href='" + url + "' target='_blank'>点我播放</a>");
                $("#goodsVideourl").val(url);
                layer.msg('上传成功', {
                    icon: 6,
                    time: 2000
                });
            }
        },
        progressall: function (e, data) {//上传进度
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $("#goodsVideourl").html("上传总进度："+progress+"%");
        },
        fail: function () {
            layer.msg('上传失败了', {icon: 5});
        }
    });
    
    var submitFrom = function() {
    	$('#saveGoodsForm').ajaxSubmit({
    		url: $("#fileServer").val() + '/goods/saveGoods',
    		type: 'POST',
			data: {
                'goodsContent': editor.txt.html()
			},
    		success: function(data) {
    			
    			if (data.status == 200) {
                    layer.msg('商品添加/更新成功', {icon: 6});
    			} else {
                    layer.msg(data.msg, {icon: 5});
    			}
                //跳转页面
                $('#goodsListMenu').click();
    		},fail: function (e) {
                layer.msg('出现了未知错误', {icon: 5});
            }
    	});
    }
    
    $('#saveGoodsForm').validate({
    	errorElement: 'span', //default input error message container
        errorClass: 'help-block', // default input error message class
        focusInvalid: false, // do not focus the last invalid input
        ignore: "", // validate all fields including form hidden input
        rules: {
            goodsName: {
                required: true,
                rangelength: [1,8]
            },
            goodsCharacteristic: {
                required: true,
                rangelength: [1,15]
            },
            goodsOriginalprice: {
                required: true,
                min: 0.01
            },
            goodsMinprice: {
                min: 0.01
            },
            goodsStock: {
                required: true,
                min: 1
            },
            goodsPicurl: {
                required: true
            }
        },
        messages: {
            goodsName: {
                required: "商品名字不能为空.",
                rangelength: "名字长度请控制在1-8位."
            },
            goodsCharacteristic: {
                required: "商品简述不能为空",
				rangelength: "简述控制在1~15个字"
			},
            goodsOriginalprice: {
                required: "商品原价不能为空",
                min: "最低价格不能低于0.01"
            },
            goodsMinprice: {
                min: "最低价格不能低于0.01"
            },
            goodsStock: {
                required: "商品库存不能为空",
                min: "商品库存至少为1"
            },
            goodsPicurl: {
                required: "商品封面不能为空."
            }
        },
        invalidHandler: function(event, validator) { //display error alert on form submit   
            $('.alert-danger', $('#saveGoodsForm')).show();
        },

        highlight: function(element) { // hightlight error inputs
            $(element).closest('.form-group').addClass('has-error'); // set error class to the control group
        },
        success: function(label) {
            label.closest('.form-group').removeClass('has-error');
            label.remove();
        },
        errorPlacement: function(error, element) {
            error.insertAfter(element.closest('#input-error'));
        },
        submitHandler: function(form) {
        	// FIXME
        	submitFrom();
        }
    });
</script>

</div>